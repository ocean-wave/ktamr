<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktamr.mapper.HaPaylogMapper">
     <!--映射缴费单的sql-->
     <resultMap id="HaPaylogMap" type="HaPaylog">
    <!--p-->
    <result column="billid" property="billId" />
    <result column="state" property="state"/>
    <result column="plantime" property="planTime"/>
    <result column="sum" property="sum"/>
    <result column="lastarrear" property="lastarrear"/>
    <result column="mbtime" property="mbtime"/>
    <!-- f-->
    <association property="haFreeze" javaType="HaFreeze">
        <result column="delta" property="delta"/>

    </association>
    <!--mi-->
    <association property="havMeterinfo" javaType="HavMeterinfo">
        <result column="userNo" property="userNo"/>
        <result column="userName" property="userName"/>
        <result column="userDs" property="userDs"/>
    </association>
    <!--ps-->
    <association property="haPricestandard" javaType="HaPricestandard">
        <result column="name" property="name"/>

    </association>
</resultMap>
     <!--查询缴费单列表-->
     <select id="selectHaPaylogList" resultMap="HaPaylogMap">
        select * from (
     SELECT p.billid as billid
		, mi.用户号 as userNo
		, mi.用户名 as userName
		, mi.用户地址 as userDs
		, p.state as pstate
		, to_char(p.plantime, 'YYYY-MM-DD hh24:mm:ss') as plantime
		, ps.name AS name
		, f.delta AS delta
		, p.sum as sum

		, COALESCE(p.lastarrear, 0) as lastarrear
		, to_char(p.mbtime, 'YYYY-MM-DD hh24:mm:ss') as mbtime
		 FROM ((ha_paylog p LEFT JOIN ha_freeze f ON p.billid=f.billid)
		 LEFT JOIN hav_meterinfo mi ON f.meterid=mi.meterid)
		 LEFT JOIN ha_priceStandard ps ON f.pricestand_id=ps.pricestand_id
                                 WHERE p.billid is not null
    <if test="HaPaylog.state != null and HaPaylog.state != ''">
        and state = #{HaPaylog.state}
    </if>
         <if test="HaPaylog.idsList  != null and HaPaylog.idsList.size()>0">
             and mi.areaid in
             <foreach collection="HaPaylog.idsList" item="item" index="index"
                      open="(" separator="," close=")">
                 #{item}
             </foreach>
         </if>
    <if test="HaPaylog.haPricestandard!=null">
        <if test="HaPaylog.haPricestandard.starttime != null  and HaPaylog.haPricestandard.endtime != null ">
            and to_char(mbtime,'YYYY-mm-dd hh24:mm:ss') between
            #{HaPaylog.haPricestandard.startTime,jdbcType=CHAR}
            and
            #{HaPaylog.haPricestandard.endTime,jdbcType=CHAR}
        </if>
    </if>
         <if test="HaPaylog.keyWord!=null and HaPaylog.keyWord!=''">
             and (p.billid = '${HaPaylog.keyWord}' or mi.用户号 like '%${HaPaylog.keyWord}%' or mi.用户名 like '%${HaPaylog.keyWord}%')
         </if>
         ) t
</select>


    <!--查询月报表列表的映射-->
    <resultMap id="HaPaylogMap2" type="HaPaylog">
        <!--ha_paylog(pl)-->
        <result column="sum" property="sum" />
        <result column="lastarrear" property="lastarrear"/>
        <result column="planTime" property="planTime"/>
        <result column="mbTime" property="mbtime"/>
        <!-- ha_freeze(f)-->
        <association property="haFreeze" javaType="HaFreeze">
            <result column="itemid" property="itemId"/>
            <result column="lf_number" property="lfNumber"/>
            <result column="tf_number" property="tfNumber"/>
            <result column="th_time" property="thTime"/>
            <result column="delta" property="delta"/>
        </association>
        <!--ha_meter(m)-->
        <association property="haMeter" javaType="HaMeter">
            <result column="meterNumber" property="meterNumber"/>
            <result column="state" property="state"/>
            <result column="rate" property="rate"/>
        </association>
        <!--hav_meterinfo(mi)-->
        <association property="havMeterinfo" javaType="HavMeterinfo">
            <result column="userName" property="userName"/>
            <result column="userDs" property="userDs"/>
            <result column="userNo" property="userNo"/>
        </association>
        <!--ha_pricestandard(ps)-->
        <association property="haPricestandard" javaType="HaPricestandard">
            <result column="name" property="name"/>
           </association>
        <!--ha_meterType(mt)-->
        <association property="haMetertype" javaType="HaMetertype">
            <result column="name" property="name"/>
        </association>
    </resultMap>
    <!--查询月报表列表-->
    <select id="selectMonthReportList" resultMap="HaPaylogMap2">
        select * from (
       SELECT f.itemid AS itemid,
        mi.用户号 AS userNo,
		mi.用户名 AS userName,
		mi.用户地址 AS userDs,
		m.meterNumber AS meterNumber,
		m.state AS state,
		f.lf_number AS lf_number,
		f.tf_number AS tf_number,
		f.delta AS delta,
		to_char(f.th_time, 'YYYY-MM-DD hh:mm:ss') AS th_time,
		mt.name AS name,
		ps.name AS name,
		m.rate AS rate,
		pl.sum AS sum,
		pl.lastarrear AS lastarrear,
		to_char(pl.planTime, 'YYYY-MM-DD hh:mm:ss') AS planTime,
		to_char(pl.mbTime, 'YYYY-MM-DD hh:mm:ss') AS mbTime
	    FROM ha_paylog pl,ha_freeze f,ha_meter m,hav_meterinfo mi,ha_pricestandard ps,ha_meterType mt,
		( SELECT f.meterid,MAX(f.itemid) AS itemid
		FROM ha_freeze f
        <trim prefix="where" prefixOverrides="and | or">
            <if test="HaPaylog.KaiShiTime != null  and HaPaylog.JieShuTime != null ">
                and to_char(f.RTime, 'YYYY-MM-DD hh:mm:ss') between '${HaPaylog.KaiShiTime}' and '${HaPaylog.JieShuTime}'
            </if>
        </trim>
        GROUP BY f.meterid
        ) t
		WHERE pl.billid = f.billid AND f.itemid=t.itemid AND m.meterid = f.meterid
		AND f.meterid=mi.meterid AND f.pricestand_id = ps.pricestand_id
        <if test="HaPaylog.areaId  != null and HaPaylog.areaId !=''">
            and mi.areaid in ('${HaPaylog.areaId}')
        </if>
        <if test="HaPaylog.keyWord!=null and HaPaylog.keyWord!=''">
            and (mi.custid = '${HaPaylog.keyWord}' or mi.用户号 like '%${HaPaylog.keyWord}%' or mi.用户名 like '%${HaPaylog.keyWord}%')

        </if>
		AND ps.meterTypeId = mt.meterTypeId

        ORDER BY mi.用户号, mi.用户地址
        ) t
    </select>

    <!-- 点击打印缴费单时进行查询的map映射   -->
    <resultMap id="BselectPritJiaoFeiDanXka1" type="HaPaylog">
        <result column="费用" property="sum" />
        <result column="上期余额" property="lastarrear"/>
        <result column="出单时间" property="planTime"/>
        <result column="billid" property="billId"/>
        <result column="状态" property="state"/>
        <result column="custid" property="custId"/>
        <result column="用户名称" property="custName"/>
        <association property="haFreeze" javaType="HaFreeze">
            <result column="最近抄表时间" property="thTime"/>
        </association>
        <association property="haCustom" javaType="HaCustom">
            <result column="银行名称" property="bank"/>
            <result column="银行账户" property="account"/>
        </association>
        <association property="havMeterinfo" javaType="HavMeterinfo">
            <result column="用户地址" property="userDs"/>
        </association>
    </resultMap>
    <!--点击打印缴费单时进行查询1-->
    <select id="BselectPritJiaoFeiDan1" resultMap="BselectPritJiaoFeiDanXka1">
        SELECT
		 p.planTime AS 出单时间
		,p.sum AS 费用
		, cu.bank AS 银行名称
		, cu.account AS 银行账户
		, p.state AS 状态
		, p.cust_id AS custid
		, p.cust_name AS 用户名称
		, p.billid AS billid
		, mi.用户地址 AS 用户地址
		, f.th_time AS 最近抄表时间
		, p.lastArrear AS 上期余额
		 FROM ((ha_paylog p LEFT JOIN ha_freeze f ON
f.billid=p.billid)
		LEFT JOIN ha_custom cu ON p.cust_id=cu.custid)
		LEFT JOIN hav_meterinfo mi ON f.meterid=mi.meterid WHERE
(p.state='出单' OR p.state='完成')
        <if test="HaPaylog.billId != null and HaPaylog.billId != ''">
            and POSITION('${HaPaylog.billId}' IN p.billid)>0
        </if>

        <if test="HaPaylog.billIdsList  != null and HaPaylog.billIdsList.size()>0">
           and  p.billid in
            <foreach collection="HaPaylog.billIdsList" item="item" index="index"
                     open="(" separator="," close=")"
                      >
              '${item}'
            </foreach>

        </if>
            <if test="HaPaylog.areaId != null  and HaPaylog.areaId != null ">
                and mi.areaid=#{HaPaylog.areaId}
            </if>


        <if test="HaPaylog.KaiShiTime != null and HaPaylog.KaiShiTime != '' and HaPaylog.JieShuTime != null and HaPaylog.JieShuTime != ''">
            and to_char(p.planTime, 'YYYY-MM-DD hh:mm:ss') between '${HaPaylog.KaiShiTime}' and '${HaPaylog.JieShuTime}'
        </if>
		ORDER BY mi.用户地址,cu.custno
    </select>


</mapper>