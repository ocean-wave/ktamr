<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktamr.mapper.HaMeterMapper">

    <resultMap id="meterMap" type="com.ktamr.domain.HaMeter">
        <id column="meterId" property="meterId" javaType="java.lang.Integer" jdbcType="INTEGER"></id>

        <result column="meterNumber" property="meterNumber" javaType="java.lang.Long" jdbcType="INTEGER"></result>
        <result column="addr" property="addr" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="userDs" property="resultParams.userDs" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="thNumber" property="thNumber" javaType="java.lang.Double"></result>
        <result column="thRTime" property="thRTime" javaType="java.util.Date"></result>
        <result column="lfNumber" property="lfNumber" javaType="java.lang.Double"></result>
        <result column="sNumber" property="sNumber" javaType="java.lang.Double"></result>
        <result column="zjsl" property="resultParams.zjsl" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="sfny" property="resultParams.sfny" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="sycjs" property="resultParams.sycjs" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="ysl" property="resultParams.ysl" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="csdrbj" property="resultParams.csdrbj" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="cbrq" property="resultParams.cbrq" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="amtabnum" property="resultParams.amtabnum" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="watermete" property="resultParams.watermete" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="cbtdate" property="resultParams.cbtdate" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="state" property="state" javaType="java.lang.String" jdbcType="VARCHAR"></result>

        <association property="haCollector" javaType="com.ktamr.domain.HaCollector">
            <result column="nconf" property="resultParams.nconf" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        </association>
        <association property="haFreeze" javaType="com.ktamr.domain.HaFreeze">
            <result column="ftfNumber" property="tfNumber" javaType="java.lang.String" jdbcType="VARCHAR"></result>
            <result column="fthTime" property="thTime" javaType="java.util.Date"></result>
            <result column="fdelta" property="delta" javaType="java.lang.String"></result>
            <result column="flfNumber" property="lfNumber" javaType="java.lang.String"></result>
        </association>
        <association property="haRoom" javaType="com.ktamr.domain.HaRoom">
            <result column="rname" property="name" javaType="java.lang.String" jdbcType="VARCHAR"></result>
            <association property="custom" javaType="com.ktamr.domain.HaCustom">
                <result column="userNo" property="custNo" javaType="java.lang.String" jdbcType="VARCHAR"></result>
                <result column="userName" property="name" javaType="java.lang.String" jdbcType="VARCHAR"></result>
                <result column="cuBalance" property="balance" javaType="java.lang.Integer" jdbcType="INTEGER"></result>
            </association>
        </association>
    </resultMap>

    <sql id="getRightCondition">
        <if test=" params.operatorRgnType != null and params.operatorRgnType != '' ">
            <if test=" params.operatorRgnType == 'rgn' ">
                and LEFT(a.areaNo,1) in (#{params.rgnStr})
            </if>
            <if test=" params.operatorRgnType == 'area' ">
                and a.areano in (#{params.areaNo})
            </if>
        </if>
    </sql>

    <select id="selectAllMeter" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        t1.itemid
        , mi.用户号 AS userNo
        , mi.用户名 AS userName
        , mi.用户地址 AS userDs
        , trim(to_char(mi.表号, '9999999999999999')) AS uNo
        , t1.bcds
        , t1.scds
        , t1.csyl
        , t1.bzt
        , t1.bccbTime
        , t1.sccbTime
        FROM hav_meterinfo mi
        LEFT JOIN (
            SELECT rc1.itemid AS itemid
            , rc1.meterid AS meterid
            , rc1.th_number AS bcds
            , rc1.lf_number AS scds
            , rc1.delta AS csyl
            , rc1.state AS bzt
            , to_char(rc1.th_time, 'yyyy-mm-dd hh24:mi:ss') AS bccbTime
            ,to_char(rc1.lf_time, 'yyyy-mm-dd hh24:mi:ss') AS sccbTime
            FROM ha_records rc1
            WHERE rc1.cmdid IN <foreach item="id" index="index" collection="cmdids"
                                        open="(" separator="," close=")">
                                ${id}
                            </foreach>
            UNION ALL
            SELECT er1.itemid AS itemid
            , er1.meterid AS meterid
            , er1.n AS bcds
            , 0 AS scds
            , 0 AS csyl
            , er1.state AS bzt
            , to_char(er1.readtime, 'yyyy-mm-dd hh24:mi:ss') AS bccbTime
            , '' AS sccbTime
            FROM ha_errRecord er1
            WHERE er1.cmdid IN <foreach item="id" index="index" collection="cmdids"
                                        open="(" separator="," close=")">
                                ${id}
                            </foreach>)
            t1 ON t1.meterid=mi.meterid
        where 1=1
        <if test=" cmdName == '抄收区域' ">
            and mi.areaid IN (
            SELECT a.areaid FROM ha_rgn n, ha_area a
            WHERE n.id=Left(a.areaNo, 1) and #{ids} = n.id)
        </if>
        <if test=" cmdName == '抄收小区' ">
            and mi.areaid IN  <foreach item="id" index="index" collection="ids"
                                  open="(" separator="," close=")">
                          ${id}
                    </foreach>
        </if>

    </select>

    <select id="selectMeterById" resultType="java.util.Map" parameterType="java.lang.Integer">
        SELECT
          th_number AS mthnumber
          , to_char(th_r_time, 'yyyy-mm-dd hh24:mi:ss') AS mthrtime
          , state AS mstate
          , s_number AS msnumber
          FROM ha_meter WHERE meterid=#{meterid}
    </select>

    <select id="selectMeterAndBuildingById" resultType="java.util.Map" parameterType="java.lang.Integer">
        SELECT CASE WHEN cu.custno is null THEN  '*' ELSE cu.custno End AS custno
        , CASE WHEN cu.name is null THEN '*' ELSE cu.name END AS name
        , a.name||'-'||b.name||'-'||r.name AS ds
        ,m.meterNumber AS meterNumber
        FROM (((ha_meter m LEFT JOIN ha_room r ON m.roomid=r.roomid)
        LEFT JOIN ha_building b ON r.buildingid=b.buildingid)
        LEFT JOIN ha_area a ON m.areaid=a.areaid)
        LEFT JOIN ha_custom cu ON r.custid=cu.custid
        WHERE m.meterid =#{meterid}
    </select>

    <select id="selectDosageRecently" resultType="java.util.Map" parameterType="com.ktamr.common.parameter.ParameterInfo">
        SELECT
        m.meterid AS id
        , mi.用户号 AS userNo
        , mi.用户名 AS userName
        , mi.用户地址 AS userDs
        ,m.meterNumber AS meterNumber
        , trim(to_char(m.th_number, '99999999999999')) AS thNumber
        ,trim(to_char(m.lf_number, '99999999999999')) AS lfNumber
        ,trim(to_char(m.s_number, '99999999999999')) AS sNumber
        , m.state AS state
        ,to_char(m.th_r_time, 'yyyy-mm-dd hh24:mi:ss') AS thrTime
        ,to_char(m.lf_time, 'yyyy-mm-dd hh24:mi:ss') AS lfTime
        FROM ha_meter m, hav_meterinfo mi, ha_area a
        WHERE m.meterid=mi.meterid AND a.areaid=mi.areaid
        <if test=" nodeType == 'area' and nodeIds != '' ">
            AND a.areaid IN (cast(#{nodeIds} as INTEGER))
        </if>
        <if test=" nodeType == 'rgn' and nodeIds != '' ">
            AND Left(a.areaNo, 1) IN (#{nodeIds})
        </if>
        <if test=" monthType != null and monthType != '' ">
            AND a.DS=#{monthType}
        </if>
        <if test=" wheresql != null and wheresql != '' ">
            ${wheresql}
        </if>
        <if test=" keyWord != null and keyWord != '' ">
            and (mi.用户号 like '%${keyWord}%' or mi.用户名 like '%${keyWord}%'
            or mi.用户地址 like '%${keyWord}%' or m.state = #{keyWord}
            or to_char(mi.表号,'999999999999999') like '%${keyWord}%'
            or trim(to_char(m.th_number, '99999999999999')) like '%${keyWord}%'
            or trim(to_char(m.lf_number, '99999999999999')) like '%${keyWord}%'
            or trim(to_char(m.s_number, '99999999999999')) like '%${keyWord}%'
            or to_char(m.th_r_time, 'yyyy-mm-dd hh24:mi:ss') like '%${keyWord}%'
            or to_char(m.lf_time, 'yyyy-mm-dd hh24:mi:ss') like '%${keyWord}%')
        </if>
        ORDER BY mi.用户地址
    </select>

    <select id="selectDosageHistory" resultType="java.util.Map" parameterType="com.ktamr.common.parameter.ParameterInfo">
        SELECT
        t1.itemid AS id
        ,mi.用户号 AS userNo
        , mi.用户名 AS userName
        , mi.用户地址 AS userDs
        , mi.表号 AS meterNumber
        , t1.thNumber
        , t1.lfNumber
        , t1.delta
        , t1.state
        , t1.thTime
        , t1.lfTime
        FROM hav_meterinfo mi, ha_area a,
            (SELECT rc1.itemid AS itemid
             , rc1.meterid AS meterid
             , rc1.th_number AS thNumber
             , rc1.lf_number AS lfNumber
             , rc1.delta AS delta
             , rc1.state AS state
             , to_char(rc1.th_time, 'yyyy-mm-dd hh24:mi:ss') AS thTime
             ,to_char(rc1.lf_time, 'yyyy-mm-dd hh24:mi:ss') AS lfTime
            FROM ha_records rc1,
             (SELECT rc.meterid,to_char(rc.th_time, 'YYYY-MM-DD'),MAX(rc.itemid) as itemid FROM ha_records rc GROUP BY rc.meterid,to_char(rc.th_time, 'YYYY-MM-DD')) t
            WHERE rc1.itemid=t.itemid
            UNION ALL
            SELECT er1.itemid AS itemid
            , er1.meterid AS meterid
            ,0 AS thNumber
            ,0 AS lfNumber
            , er1.n AS delta
            , er1.state AS state
            , to_char(er1.readtime, 'yyyy-mm-dd hh24:mi:ss') AS thTime
            ,'' AS lfTime
            FROM ha_errRecord er1,
            (
            SELECT er.meterid
            ,to_char(er.readtime, 'YYYY-MM-DD')
            ,MAX(er.itemid) as itemid
            FROM ha_errRecord er
            GROUP BY er.meterid,to_char(er.readtime, 'YYYY-MM-DD')) t WHERE er1.itemid=t.itemid) t1
        WHERE t1.meterid=mi.meterid AND a.areaid=mi.areaid
        <if test=" nodeType == 'area' and nodeIds != '' ">
            AND a.areaid IN (cast(#{nodeIds} as INTEGER))
        </if>
        <if test=" nodeType == 'rgn' and nodeIds != '' ">
            AND Left(a.areaNo, 1) IN (#{nodeIds})
        </if>
        <if test=" monthType != null and monthType != '' ">
            AND a.DS=#{monthType}
        </if>
        <if test=" wheresql != null and wheresql != '' ">
            ${wheresql}
        </if>
        <if test=" keyWord != null and keyWord != '' ">
            and (mi.用户号 like '%${keyWord}%' or mi.用户名 like '%${keyWord}%'
            or mi.用户地址 like '%${keyWord}%'
            )
        </if>
        <if test=" startDate != null and startDate != '' and endDate != null and endDate != '' ">
            AND to_char(to_date(t1.thTime,'yyyy-mm-dd'),'yyyy-mm-dd') BETWEEN #{startDate} AND #{endDate}
        </if>
    </select>

    <select id="selectNotok" resultType="java.util.Map" parameterType="com.ktamr.common.parameter.ParameterInfo">
        SELECT mi.meterid AS meterid
        ,mi.用户号 AS userNo
        ,mi.用户名 AS userName
        ,mi.用户地址 AS userDs
        ,trim(to_char(mi.表号, '9999999999999999')) AS meterNumber
        ,t.th_number AS thNumber
        ,t.lf_number AS lfNumber
        ,t.s_number AS sNumber
        ,mi.状态 AS state
        ,mi.抄表时间 AS firstTime
        , t.centorNo AS centorNo
        , to_hex(t.nconf) AS nconf
        FROM hav_meterinfo mi,ha_area a,(SELECT * FROM (ha_meter m LEFT JOIN ha_centor ce ON m.centorid=ce.id) LEFT JOIN ha_collector co ON m.collectorid=co.collectorid) t
        WHERE mi.状态!='正常'
        AND mi.状态!='正确'
        AND mi.状态!='建档'
        AND mi.状态!='集中器无返回'
        AND mi.状态!='关阀'
        AND mi.状态!='修改'
        AND mi.状态!='已更正'
        AND mi.状态!='已更换'
        AND mi.状态!='采集器无返回'
        AND mi.状态 NOT LIKE '%用量异常%'
        AND mi.表号 >0
        AND mi.meterid=t.meterid AND mi.areaid=a.areaid
        <if test=" nodeType == 'area' and nodeIds != '' ">
            AND a.areaid IN (cast(#{nodeIds} as INTEGER))
        </if>
        <if test=" nodeType == 'rgn' and nodeIds != '' ">
            AND Left(a.areaNo, 1) IN (#{nodeIds})
        </if>
        <if test=" dataType !=null and dataType != '' ">
            AND mi.状态 IN <foreach item="zt" index="index" collection="dataTypes"
                                     open="(" separator="," close=")">
                              #{zt}
                          </foreach>
        </if>
        <if test=" keyWord != null and keyWord != '' ">
            and (mi.用户号 like '%${keyWord}%' or mi.用户名 like '%${keyWord}%'
            or mi.用户地址 like '%${keyWord}%' or trim(to_char(mi.表号, '9999999999999999')) like '%${keyWord}%'
            or trim(to_char(t.lf_number, '9999999999999999')) like '%${keyWord}%'
            or trim(to_char(t.s_number, '9999999999999999')) like '%${keyWord}%'
            or mi.状态 =#{keyWord} or  t.centorNo like '%${keyWord}%'
            or to_hex(t.nconf) like '%${keyWord}%'
            )
        </if>
        ORDER BY mi.用户地址, mi.状态, mi.用户号
    </select>

    <select id="selectThirdParty" resultMap="meterMap" parameterType="com.ktamr.domain.HaMeter">
        <if test=" params.showListType == 'sys_zjss' or params.showListType == '' ">
            SELECT
            mi.meterid AS meterId
            , mi.用户号 AS userNo
            , trim(to_char(mi.表号, '9999999999999999')) AS meterNumber
            , mi.用户地址 AS userDs
            , trim(to_char(mi.最近度数, '9999999999999999')) AS thNumber
            , mi.抄表时间 AS thRTime
            FROM hav_meterinfo mi
            LEFT JOIN ha_area a ON mi.areaid=a.areaid
            WHERE  mi.meterid IS NOT NULL
            <if test=" params.keyWord != null and params.keyWord != '' ">
              and ( mi.用户号 like '%${params.keyWord}%' or to_char(mi.表号, 'fm9999999999999999') like '%${params.keyWord}%'
                  or mi.用户地址 like '%${params.keyWord}%' or to_char(mi.最近度数, 'fm9999999999999999') like '%${params.keyWord}%'
                  or mi.抄表时间 like '%${params.keyWord}%')
            </if>
        </if>
        <if test=" params.showListType == 'sys_ntrq'">
            SELECT mi.meterid AS meterId
            , mi.用户号 AS userNo
            , mi.表地址 AS addr
            , mi.用户名 AS userName
            , mi.用户地址 AS userDs
            , trim(to_char(mi.最近度数, '9999999999999999')) AS thNumber
            , mi.抄表时间 AS thRTime
            ,mi.状态 AS state
            FROM hav_meterinfo mi
            LEFT JOIN ha_area a ON mi.areaid=a.areaid
            WHERE mi.meterid IS NOT NULL
            <if test=" params.keyWord != null and params.keyWord != '' ">
                and ( mi.用户号 like '%${params.keyWord}%' or mi.表地址 like '%${params.keyWord}%'
                or mi.用户名 like '%${params.keyWord}%' or mi.用户地址 like '%${params.keyWord}%'
                or to_char(mi.最近度数, 'fm9999999999999999') like '%${params.keyWord}%'
                or mi.抄表时间 like '%${params.keyWord}%')
                or mi.状态 = #{params.keyWord})
            </if>
        </if>
        <if test=" params.showListType == 'sys_hsss'">
            SELECT mi.meterid AS meterId
            , mi.用户号 AS userNo
            , mi.用户名 AS userName
            , trim(to_char(mi.表号, '9999999999999999')) AS meterNumber
            , mi.小区名||'-'||b.name AS userDs
            , r.name AS rname
            , trim(to_char(mi.最近度数, '9999999999999999')) AS thNumber
            , mi.抄表时间 AS thRTime
            FROM ((hav_meterinfo mi LEFT JOIN ha_area a ON mi.areaid=a.areaid)
            LEFT JOIN ha_building b ON mi.buildingid=b.buildingid)
            LEFT JOIN ha_room r ON mi.roomid=r.roomid
            WHERE mi.meterid IS NOT NULL
        </if>
        <if test=" params.showListType == 'sys_tzss'">
            SELECT f.meterid AS meterId
            , mi.用户号 AS userNo
            , CASE WHEN length(mi.用户名)>0 THEN mi.用户名 ELSE '*' END AS userName
            , trim(to_char(f.tf_number, '9999999999999999')) AS ftfNumber
            , f.th_time AS fthTime
            , trim(to_char(f.delta, '9999999999999999')) AS fdelta
            , '0' AS zjsl
            , mi.状态 AS state
            , trim(to_char(f.lf_number, '9999999999999999')) AS flfNumber
            FROM ha_area a, hav_meterinfo mi, ha_freeze f, ha_paylog pl
            WHERE mi.meterid=f.meterid AND f.billId=pl.billId AND pl.state='完成' AND mi.areaid=a.areaid
            <if test=" params.queryMonth != null and params.queryMonth !='' ">
              AND to_char(f.RTime, 'yyyy-mm')=#{params.queryMonth}
            </if>
        </if>
        <if test=" params.showListType == 'sys_pkss'">
            SELECT mi.meterid AS meterId
            , mi.用户号 AS userNo
            , to_char(to_date(mi.抄表时间,'yyyy-MM-dd'),'yyyyMM') AS sfny
            , null AS sycjs
            , trim(to_char(mi.最近度数, '9999999999999999')) AS thNumber
            , mi.抄表时间 AS thRTime
            , null AS ysl
            , trim(to_char(mi.表号, '9999999999999999')) AS meterNumber
            , 0 AS csdrbj
            FROM hav_meterinfo mi
            LEFT JOIN ha_area a ON mi.areaid=a.areaid
            WHERE mi.meterid IS NOT NULL
        </if>
        <if test=" params.showListType == 'sys_rass'">
            SELECT mi.meterid AS meterId
            , mi.用户号 AS userNo
            , trim(to_char(mi.最近度数, '9999999999999999')) AS thNumber
            , to_char(to_date(mi.抄表时间,'yyyy-MM-dd'), 'YYYYMMDD') AS cbrq
            FROM hav_meterinfo mi
            LEFT JOIN ha_area a ON mi.areaid=a.areaid
            WHERE mi.meterid IS NOT NULL
        </if>
        <if test=" params.showListType == 'sys_jrss'">
            SELECT mi.meterid AS meterId
            , mi.用户号 AS userNo
            , '' AS amtabnum
            , trim(to_char(mi.最近度数, '9999999999999999')) AS thNumber
            , '' AS watermete
            , to_char(to_date(mi.抄表时间,'yyyy-MM-dd'), 'YYYY/MM/DD') AS cbtdate
            FROM hav_meterinfo mi
            LEFT JOIN ha_area a ON mi.areaid=a.areaid
            WHERE mi.meterid IS NOT NULL
        </if>
        <if test=" params.showListType == 'sys_hncc'">
            SELECT mi.meterid AS meterId
            , mi.用户号 AS userNo
            , mi.用户名 AS userName
            , trim(to_char(mi.表号, '9999999999999999')) AS meterNumber
            , trim(to_char(m.lf_number, '9999999999999999')) AS lfNumber
            , trim(to_char(cu.balance, '9999999999999999')) AS cuBalance
            FROM hav_meterinfo mi
            LEFT JOIN ha_area a ON mi.areaid=a.areaid
            LEFT JOIN ha_room r ON mi.roomid=r.roomid
            LEFT JOIN ha_meter m ON mi.meterid=m.meterid
            LEFT JOIN ha_custom cu ON cu.custid=r.custid
            WHERE mi.meterid IS NOT NULL
        </if>
        <if test=" params.showListType == 'sys_nyss'">
            SELECT mi.meterid AS meterId
            , trim(to_char(mi.表号, '9999999999999999')) AS meterNumber
            , mi.用户号 AS userNo
            , mi.抄表时间 AS thRTime
            , trim(to_char(mi.最近度数, '9999999999999999')) AS thNumber
            FROM hav_meterinfo mi
            LEFT JOIN ha_area a ON mi.areaid=a.areaid
            WHERE mi.meterid IS NOT NULL
        </if>
        <include refid="getRightCondition"></include>
        <if test=" params.nodeType == 'area' and params.nodeIds != '' ">
            AND a.areaid IN (cast(#{params.nodeIds} as INTEGER ))
        </if>
        <if test=" params.nodeType == 'rgn' and params.nodeIds != '' ">
            and Left(a.areaNo, 1) in (#{params.nodeIds})
            <if test=" params.monthType != '' ">
                AND a.DS=#{params.monthType}
            </if>
        </if>
        ORDER BY mi.用户号
    </select>

    <select id="selectRecordByHand" resultMap="meterMap" parameterType="com.ktamr.domain.HaMeter">
        SELECT m.meterid AS meterId
        , mi.用户号 AS userNo
        , mi.用户名 AS userName
        , mi.用户地址 AS userDs
        ,m.meterNumber AS meterNumber
        ,to_char(m.th_number, 'fm99999999999999') AS thNumber
        ,to_char(m.lf_number, 'fm99999999999999') AS lfNumber
        ,to_char(m.s_number, 'fm99999999999999') AS sNumber
        , m.state AS state
        ,to_char(m.th_r_time, 'yyyy-mm-dd hh24:mi:ss') AS thRTime
        ,to_char(m.lf_time, 'yyyy-mm-dd hh24:mi:ss') AS lfTime
        ,m.th_number AS recentRead
        , m.state AS recentreadstate
        , to_char(m.th_r_time, 'yyyy-mm-dd hh24:mi:ss') AS recentreadtime
        FROM ha_meter m, hav_meterinfo mi, ha_area a
        WHERE m.meterid=mi.meterid AND a.areaid=mi.areaid
        <include refid="getRightCondition"></include>
        <if test=" params.keyWord != null and params.keyWord != '' ">
            and ( mi.用户号 like '%${params.keyWord}%' or mi.用户名 like '%${params.keyWord}%'
            or mi.用户地址 like '%${params.keyWord}%' or to_char(m.meterNumber,'fm99999999999999') like '%${params.keyWord}%'
            or to_char(mi.最近度数, 'fm9999999999999999') like '%${params.keyWord}%'
            or to_char(m.lf_number, '99999999999999') like '%${params.keyWord}%'
            or to_char(m.s_number, '99999999999999') like '%${params.keyWord}%'
            or m.state = #{params.keyWord}
            or to_char(m.th_r_time, 'yyyy-mm-dd hh24:mi:ss') like '%${params.keyWord}%')
        </if>
        ORDER BY mi.用户地址
    </select>

    <update id="updateMeter"  parameterType="com.ktamr.domain.HaMeter">
        UPDATE ha_meter  SET th_number=#{thNumber},th_r_time=#{thRTime},s_number=#{thNumber}-lf_number,
        state=#{state},fday=to_date(#{thRTime},'yyyy-mm-dd')-1,fmon=to_date(#{thRTime},'yyyy-mm-dd')-CAST(date_part('day', current_date)  as  INTEGER),
        fday_n=#{thNumber},fmon_n=#{thNumber}
        WHERE meterid=#{meterId}
    </update>

    <select id="selectLoadCollectorMeter" resultMap="meterMap" parameterType="com.ktamr.domain.HaMeter">
        SELECT m.meterId AS meterId
        , cu.custno AS userNo
        , a.name||'-'||b.name||'-'||r.name AS userDs
        , cu.name AS userName
        , m.meterNumber AS meterNumber
        , m.state AS state
        , to_hex(co.nconf) AS nconf
        FROM ha_meter m
        LEFT JOIN ha_room r ON m.roomid=r.roomid
        LEFT JOIN ha_building b ON r.buildingid=b.buildingid
        LEFT JOIN ha_area a ON m.areaid=a.areaid
        LEFT JOIN ha_custom cu ON r.custid=cu.custid
        LEFT JOIN ha_collector co ON m.collectorid=co.collectorid
        WHERE m.centorid=#{haCentor.centorId}
         ORDER BY cu.custno,b.name||'-'||r.name,to_hex(co.nconf)
    </select>




    <resultMap id="queryHaMeterMap" type="com.ktamr.domain.HaMeter">
        <id property="meterId" column="meterId"/>
        <result  property="meterNumber" column="meterNumber"/>
        <result property="areaId" column="areaId"/>
        <result property="collectorId" column="collectorId"/>

        <association property="havMeterinfo" javaType="com.ktamr.domain.HavMeterinfo">
            <id property="meterid" column="meterid"/>
            <result property="userNo" column="userNo"/>
            <result property="userName" column="userName"/>
            <result property="userDs" column="userDs"/>
        </association>

        <association property="haArea" javaType="com.ktamr.domain.HaArea">
            <id property="areaId" column="areaid"/>
        </association>
    </resultMap>

    <select id="queryHaMeter" resultMap="queryHaMeterMap">
        SELECT m.meterid as meterId,
        mi.userNo AS userNo,
        mi.userName AS userName,
        mi.userDs AS userDs,
        m.meterNumber AS meterNumber
        from (ha_meter m LEFT JOIN hav_meterinfo mi ON m.meterid=mi.meterid)
        LEFT JOIN ha_area a ON m.areaid=a.areaid WHERE m.meterid>0
        <if test="collectorid!=null">
            and m.collectorid=#{collectorid}
        </if>
        <if test="areaId!=null">
            AND a.areaid=#{areaId}
        </if>
        order by mi.userDs
    </select>
</mapper>