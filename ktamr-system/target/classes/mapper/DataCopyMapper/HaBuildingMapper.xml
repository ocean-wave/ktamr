<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktamr.mapper.HaBuildingMapper">

    <resultMap id="buildingMap" type="com.ktamr.domain.HaBuilding">
        <result column="roomMeterid" property="resultParams.roomMeterid" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="cuds" property="resultParams.cuds" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="acontor" property="resultParams.acontor" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="collector" property="resultParams.collector" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="mstate" property="resultParams.state" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="maddr" property="resultParams.maddr" javaType="java.lang.String" jdbcType="VARCHAR"></result>

        <association property="room" resultMap="roomMap">

        </association>

    </resultMap>

    <resultMap id="roomMap" type="com.ktamr.domain.HaRoom">
        <result column="rdescription" property="description" javaType="java.lang.String" jdbcType="VARCHAR"></result>

        <association property="custom" javaType="com.ktamr.domain.HaCustom">
            <result column="custNo" property="custNo" javaType="java.lang.String" jdbcType="VARCHAR"></result>
            <result column="cuName" property="name" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        </association>

        <association property="meter" resultMap="meterMap">

        </association>
    </resultMap>

    <resultMap id="meterMap" type="com.ktamr.domain.HaMeter">
        <result column="maddr" property="addr" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="mmeterNumber" property="meterNumber" javaType="java.lang.Long"></result>
        <result column="mthNumber" property="thNumber" javaType="java.lang.Double"></result>
        <result column="mlfNumber" property="lfNumber" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="msNumber" property="sNumber" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="mstate" property="state" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        <result column="mthRTime" property="thRTime" javaType="java.util.Date"></result>
        <result column="mgNumber" property="gNumber" javaType="java.lang.Double"></result>
        <result column="moffsetn" property="offsetN" javaType="java.lang.Integer" jdbcType="INTEGER"></result>
        <result column="mstartTime" property="startTime" javaType="java.util.Date"></result>
        <result column="mmeterChannel" property="meterChannel" javaType="java.lang.Integer" jdbcType="INTEGER"></result>
        <result column="mmeterSequence" property="meterSequence" javaType="java.lang.Integer" jdbcType="INTEGER"></result>

        <association property="haVendor" javaType="com.ktamr.domain.HaVendor">
            <id column="mvendorId" property="vendorId"></id>
        </association>

        <association property="haCentor" javaType="com.ktamr.domain.HaCentor">
            <id column="centorId" property="id" javaType="java.lang.Integer" jdbcType="INTEGER"></id>
        </association>

        <association property="haPricestandard" javaType="com.ktamr.domain.HaPricestandard">
            <result column="pname" property="name" javaType="java.lang.String" jdbcType="VARCHAR"></result>
        </association>
    </resultMap>


    <sql id="getRightCondition">
        <if test=" params.operatorRgnType != null and params.operatorRgnType != '' ">
            <if test=" params.operatorRgnType == 'rgn' ">
                and LEFT(a.areaNo,1) in (#{params.rgnStr})
            </if>
            <if test=" params.operatorRgnType == 'area' ">
                and a.areaNo in (#{params.areaNo})
            </if>
        </if>
    </sql>

    <select id="selectAllBuildingAndCount" resultMap="buildingMap" parameterType="com.ktamr.domain.HaBuilding">
        SELECT
            to_char(r.roomid, 'fm9999999999')||'_'|| case when m.meterid is null then '' else to_char(m.meterid, 'fm9999999999') end AS roomMeterid
            , cu.custno AS custNo
            , cu.name as cuName
            , a.name||'-'||b.name||'-'||r.name AS cuds
            , r.description AS rdescription
            ,m.addr AS maddr
            , m.meterNumber AS mmeterNumber
            , m.th_number as mthNumber
            , m.lf_number as mlfNumber
            , m.s_number as msNumber
            , m.state as mstate
            , to_char(m.th_r_time, 'YYYY-MM-DD hh:mm:ss') as mthRTime
            , p.name as pname
            , case when c.addr != '' then c.addr||'['|| case when c.description='KT3NB GPRS' then to_char(c.centorid, '9') else c.centorNo ||']' end else '[无对象]' end AS acontor
            ,c.id AS centorId
            , case when co.addr != '' then co.addr||'['||to_hex(co.nconf)||']' else '[无对象]' end AS collector
            , m.g_number AS mgNumber
            , to_char(m.offset_n, '9') AS moffsetn
            , m.vendor_id AS mvendorId
            , m.meter_channel AS mmeterChannel
            , m.meter_sequence AS mmeterSequence
            , m.starttime as mstartTime
        FROM
            ha_room r LEFT JOIN ha_custom cu ON r.custid=cu.custid
            LEFT JOIN ha_meter m ON m.roomid=r.roomid
            LEFT JOIN ha_centor c ON c.id=m.centorid
            LEFT JOIN ha_collector co ON co.collectorid=m.collectorid
            LEFT JOIN ha_pricestandard p ON m.pricestand_id=p.pricestand_id
            LEFT JOIN ha_building b ON r.buildingid=b.buildingid
            LEFT JOIN ha_area a ON a.areaid=b.areaid
        WHERE r.roomid>0
        <include refid="getRightCondition"></include>
        <if test=" areaId != null and areaId != '' ">
            and a.areaid=#{areaId}
        </if>
        <if test=" buildingId != null and buildingId != '' ">
            and r.buildingid = #{buildingId}
        </if>
        <if test=" params.keyWord != null and params.keyWord != ''  ">
                and (a.name||'-'||b.name||'-'||r.name like '${params.keyWord}' or cu.name like '%${params.keyWord}%' or a.areaNo like '${params.keyWord}'
                    or r.description like '${params.keyWord}' or m.state = #{params.keyWord} or to_char(m.th_r_time, 'YYYY-MM-DD hh:mm:ss') like '${params.keyWord}'
                <if test=" params.operatorCompanyId == 'sys_ntrq'  ">
                    or m.addr like '${params.keyWord}'
                </if>
                <if test=" params.operatorCompanyId != 'sys_ntrq'  ">
                    or to_char(m.meterNumber,'fm999999999999') like '${params.keyWord}'
                </if>
                )
        </if>
        ORDER BY a.name||'-'||b.name||'-'||r.name
    </select>

</mapper>