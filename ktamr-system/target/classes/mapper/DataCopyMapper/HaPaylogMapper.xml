<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktamr.mapper.HaPaylogMapper">
     <!--映射缴费单的sql-->
     <resultMap id="HaPaylogMap" type="HaPaylog">
    <!--p-->
    <result column="pbillid" property="billId" />
    <result column="pstate" property="state"/>
    <result column="pplantime" property="planTime"/>
    <result column="psum" property="sum"/>
    <result column="plastarrear" property="lastarrear"/>
    <result column="pmbtime" property="mbtime"/>
    <!-- f-->
    <association property="haFreeze" javaType="HaFreeze">
        <result column="fdelta" property="delta"/>

    </association>
    <!--mi-->
    <association property="havMeterinfo" javaType="HavMeterinfo">
        <result column="用户编号" property="userNo"/>
        <result column="用户名称" property="userName"/>
        <result column="用户地址" property="userDs"/>
    </association>
    <!--ps-->
    <association property="haPricestandard" javaType="HaPricestandard">
        <result column="psname" property="name"/>

    </association>
</resultMap>
     <!--查询缴费单列表-->
     <select id="selectHaPaylogList" resultMap="HaPaylogMap">

     SELECT p.billid as pbillid
		, mi.用户号 as 用户编号
		, mi.用户名 as 用户名称
		, mi.用户地址 as 用户地址
		, p.state as pstate
		, to_date(to_char(p.plantime, 'YYYY-MM-DD hh:mm:ss'),'YYYY-MM-DD hh:mm:ss') as pplantime
		, ps.name AS psname
		, f.delta AS fdelta
		, p.sum as psum

		, COALESCE(p.lastarrear, 0) as plastarrear
		, to_date(to_char(p.mbtime, 'YYYY-MM-DD hh:mm:ss'),'YYYY-MM-DD hh:mm:ss') as pmbtime
		 FROM ((ha_paylog p LEFT JOIN ha_freeze f ON p.billid=f.billid)
		 LEFT JOIN hav_meterinfo mi ON f.meterid=mi.meterid)
		 LEFT JOIN ha_priceStandard ps ON f.pricestand_id=ps.pricestand_id
                                 WHERE p.billid is not null

    <if test="HaPaylog.state != null and HaPaylog.state != ''">
        and state = #{HaPaylog.state}
    </if>
         <if test="HaPaylog.idsList  != null and HaPaylog.idsList.size()>0">
             and mi.areaid in
             <foreach collection="HaPaylog.idsList" item="item" index="index"
                      open="(" separator="," close=")">
                 #{item}
             </foreach>
         </if>
    <if test="HaPaylog.haPricestandard!=null">


        <if test="HaPaylog.haPricestandard.starttime != null  and HaPaylog.haPricestandard.endtime != null ">
            and mbtime between
            #{HaPaylog.haPricestandard.startTime,jdbcType=TIMESTAMP}
            and

            #{HaPaylog.haPricestandard.endTime,jdbcType=TIMESTAMP}
        </if>
    </if>
        limit #{page} OFFSET #{rowNum}
</select>

     <!--查询缴费单的记录数-->
     <select id="selectHaPaylogListCount" resultType="Integer">
        SELECT  count(1)
        FROM ((ha_paylog p LEFT JOIN ha_freeze f ON p.billid=f.billid)
		 LEFT JOIN hav_meterinfo mi ON f.meterid=mi.meterid)
		 LEFT JOIN ha_priceStandard ps ON f.pricestand_id=ps.pricestand_id
                                 WHERE p.billid is not null

        <if test="HaPaylog.state != null and HaPaylog.state != ''">
            and state = #{HaPaylog.state}
        </if>
         <if test="HaPaylog.idsList  != null and HaPaylog.idsList.size()>0">
             and mi.areaid in
             <foreach collection="HaPaylog.idsList" item="item" index="index"
                      open="(" separator="," close=")">
                 #{item}
             </foreach>
         </if>
        <if test="HaPaylog.haPricestandard!=null">
            <if test="HaPaylog.haPricestandard.starttime != null  and HaPaylog.haPricestandard.endtime != null ">
                and mbtime between
                date(#{HaPaylog.haPricestandard.startTime,jdbcType=TIMESTAMP})
                and

                date(#{HaPaylog.haPricestandard.endTime,jdbcType=TIMESTAMP})
            </if>
        </if>
    </select>

    <!--查询月报表列表的映射-->
    <resultMap id="HaPaylogMap2" type="HaPaylog">
        <!--ha_paylog(pl)-->
        <result column="plsum" property="sum" />
        <result column="pllastarrear" property="lastarrear"/>
        <result column="plplanTime" property="planTime"/>
        <result column="plmbTime" property="mbtime"/>
        <!-- ha_freeze(f)-->
        <association property="haFreeze" javaType="HaFreeze">
            <result column="itemid" property="itemId"/>
            <result column="flf_number" property="lfNumber"/>
            <result column="ftf_number" property="tfNumber"/>
            <result column="fth_time" property="thTime"/>
            <result column="fdelta" property="delta"/>

        </association>
        <!--ha_meter(m)-->
        <association property="haMeter" javaType="HaMeter">
            <result column="mmeterNumber" property="meterNumber"/>
            <result column="mstate" property="state"/>
            <result column="mrate" property="rate"/>


        </association>
        <!--hav_meterinfo(mi)-->
        <association property="havMeterinfo" javaType="HavMeterinfo">
            <result column="用户名称" property="userName"/>
            <result column="用户地址" property="userDs"/>
            <result column="用户编号" property="userNo"/>
            <result column="micustid" property="custid"/>

        </association>
        <!--ha_pricestandard(ps)-->
        <association property="haPricestandard" javaType="HaPricestandard">
            <result column="psname" property="name"/>
           </association>
        <!--ha_meterType(mt)-->
        <association property="haMetertype" javaType="HaMetertype">
            <result column="mtname" property="name"/>
        </association>
    </resultMap>
    <!--查询月报表列表-->
    <select id="selectMonthReportList" resultMap="HaPaylogMap2">

       SELECT f.itemid AS itemid,
         mi.custid as micustid,
         mi.用户号 AS 用户编号,
		mi.用户名 AS 用户名称,
		mi.用户地址 AS 用户地址,
		m.meterNumber AS mmeterNumber,
		m.state AS mstate,
		f.lf_number AS flf_number,
		f.tf_number AS ftf_number,
		f.delta AS fdelta,
		to_date(to_char(f.th_time, 'YYYY-MM-DD hh:mm:ss'),'YYYY-MM-DD hh:mm:ss') AS fth_time,
		mt.name AS mtname,
		ps.name AS psname,
		m.rate AS mrate,
		pl.sum AS plsum,
		pl.lastarrear AS pllastarrear,
		to_date(to_char(pl.planTime, 'YYYY-MM-DD hh:mm:ss'),'YYYY-MM-DD hh:mm:ss') AS plplanTime,
		to_date(to_char(pl.mbTime, 'YYYY-MM-DD hh:mm:ss'),'YYYY-MM-DD hh:mm:ss') AS plmbTime
	    FROM ha_paylog pl,ha_freeze f,ha_meter m,hav_meterinfo mi,ha_pricestandard ps,ha_meterType mt,
		( SELECT f.meterid,MAX(f.itemid) AS itemid FROM ha_freeze f inner join  ha_meter m
  on f.meterid=m.meterid  GROUP BY f.meterid, f.RTime,m.starttime,m.lasttime
 having to_date(to_char(f.RTime, 'YYYY-MM-DD hh:mm:ss'),'YYYY-MM-DD hh:mm:ss')
 BETWEEN  m.starttime  AND m.lasttime

		) t
		WHERE pl.billid = f.billid AND f.itemid=t.itemid AND m.meterid = f.meterid AND f.meterid=mi.meterid AND f.pricestand_id = ps.pricestand_id
		AND ps.meterTypeId = mt.meterTypeId
		 limit #{page} OFFSET #{rowNum}
    </select>
    <!--查询月报表列表的总记录数-->
    <select id="selectMonthReportListCount" resultType="Integer">
        SELECT count(1)
	    FROM ha_paylog pl,ha_freeze f,ha_meter m,hav_meterinfo mi,ha_pricestandard ps,ha_meterType mt,
		( SELECT f.meterid,MAX(f.itemid) AS itemid FROM ha_freeze f inner join  ha_meter m
  on f.meterid=m.meterid  GROUP BY f.meterid, f.RTime,m.starttime,m.lasttime
 having to_date(to_char(f.RTime, 'YYYY-MM-DD hh:mm:ss'),'YYYY-MM-DD hh:mm:ss')
 BETWEEN  m.starttime  AND m.lasttime

		) t
		WHERE pl.billid = f.billid AND f.itemid=t.itemid AND m.meterid = f.meterid AND f.meterid=mi.meterid AND f.pricestand_id = ps.pricestand_id
		AND ps.meterTypeId = mt.meterTypeId
    </select>


</mapper>